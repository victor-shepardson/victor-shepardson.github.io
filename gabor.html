<!DOCTYPE html>
<html>
<body>
<div id='main'></div>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="./gl-matrix-min.js"></script>
<script>
	loadShaders();
	var viewportWidth=512, viewportHeight=512;
	var sliderh = 100;
	var numsliders = 3;
	var sliders = [];
	for(var i=0; i<numsliders; i++){
		sliders[i] =
			$('<input type="range">')
			.appendTo($('#main'))
			.attr({
				min: 4,
				max: 512,
				step: 1,
				value: 100
			});
	}
	var gl = $('<canvas/>')
		.appendTo($('#main'))
		.attr('width', viewportWidth)
		.attr('height', viewportHeight)[0]
		.getContext('experimental-webgl');
		
	gl.clearColor(0.0, 0.0, 0.0, 1.0);
	gl.enable(gl.DEPTH_TEST);

	// create buffer with a rectangle
	var vertexPositionsBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, vertexPositionsBuffer);
	var vertexPositions = [
		1.0, 1.0, 0.0,
		-1.0, 1.0, 0.0,
		1.0, -1.0, 0.0,
		-1.0, -1.0, 0.0
	];

	var textureCoordinatesBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, textureCoordinatesBuffer);
	var s = viewportWidth/512.0;
	var t = viewportHeight/512.0;
	var textureCoordinates = [
		s, 1.0,
		0.0, 1.0,
		s, 1-t,
		0.0, 1-t
	];

	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(textureCoordinates), gl.STATIC_DRAW);
	textureCoordinatesBuffer.itemSize = 2;
	textureCoordinatesBuffer.numItems = 4;
	
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
	vertexPositionsBuffer.itemSize = 3;
	vertexPositionsBuffer.numItems = 4;

	var modelViewMatrix = mat4.create();
	var projectionMatrix = mat4.create();

	var program = createShaderProgram(vertexPositionsBuffer, textureCoordinatesBuffer);
	gl.useProgram(program);

	$(document).keydown( function(event) {
		event.preventDefault();
		var key = event.which;
	});

	$(document).mousemove( function(event) {
		event.preventDefault();
		// transforming cursor coordinates to [-1.0, 1.0] range
		// [0,0] being in the left bottom corner to match the vertex coordinates
		var x = (event.pageX / viewportWidth)*2.0 - 1.0;
		var y = 0.0 - ((event.pageY / viewportHeight)*2.0 - 1.0);
		gl.uniform2f(program.mouseUniform, x, y);
	});

	$(document).mousedown( function(event) {
		event.preventDefault();
		var key = event.which;
		var x = event.pageX;
		var y = event.pageY;
		if (key==1) {
			gl.uniform1i(program.mouseLeftUniform, 1);
		}
	});

	$(document).mouseup( function(event) {
		event.preventDefault();
		var key = event.which;
		if (key==1) {
			gl.uniform1i(program.mouseLeftUniform, 0);
		}
	});

	$(document).mouseleave( function(event) {
		event.preventDefault();
		gl.uniform2f(program.mouseUniform, 0, 0);
	});

	var vshader, fshader;
	function loadShaders(){
		$.ajax({
			url: './vshader.glsl',
			success: function(result) {
				vshader = result;
			},
			async:   false
		});
		$.ajax({
			url: './noise.glsl',
			success: function(result) {
				fshader = result;
            },
			async:   false
		});
	}
	
	function createShaderProgram(vertexPositionsBuffer, textureCoordinatesBuffer) {
		// create vertex shader
		var vertexShader = gl.createShader(gl.VERTEX_SHADER);
		gl.shaderSource(vertexShader, vshader);
		gl.compileShader(vertexShader);
		if (!gl.getShaderParameter(vertexShader, gl.COMPILE_STATUS)) {
			alert(gl.getShaderInfoLog(vertexShader));
		}
  
		// create fragment shader
		var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
		gl.shaderSource(fragmentShader, fshader);
		gl.compileShader(fragmentShader);
		if (!gl.getShaderParameter(fragmentShader, gl.COMPILE_STATUS)) {
			alert(gl.getShaderInfoLog(fragmentShader));
		}
		  
		// create and use program
		var program = gl.createProgram();
		gl.attachShader(program, vertexShader);
		gl.attachShader(program, fragmentShader);
		gl.linkProgram(program);
		if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
			alert(gl.getProgramInfoLog(program));
		}
		  
		// vertex attribute [position]
		program.vertexPositionAttribute = gl.getAttribLocation(program, "aVertexPosition");
		gl.enableVertexAttribArray(program.vertexPositionAttribute);
		//gl.vertexAttribPointer(program.vertexPositionAttribute, vertexPositionsBuffer.itemSize, gl.FLOAT, false, 0, 0);

		// vertex attribute [texture coordinates]
		program.textureCoordinatesAttribute = gl.getAttribLocation(program, "aTextureCoordinates");
		gl.enableVertexAttribArray(program.textureCoordinatesAttribute);
		//gl.vertexAttribPointer(program.textureCoordinatesAttribute, textureCoordinatesBuffer.itemSize, gl.FLOAT, false, 0, 0);

		// uniform variables [modelViewMatrix and projectionMatrix]
		program.mvMatrixUniform = gl.getUniformLocation(program, "modelViewMatrix");
		program.pMatrixUniform = gl.getUniformLocation(program, "projectionMatrix");
		program.tex0Uniform = gl.getUniformLocation(program, "tex0");
		program.timeUniform = gl.getUniformLocation(program, "time");
		program.mouseUniform = gl.getUniformLocation(program, "mouse");
		program.mouseLeftUniform = gl.getUniformLocation(program, "mouseLeft");

		return program;
	}

	function updateMatrices(program, mvMatrix, pMatrix) {
		gl.uniformMatrix4fv(program.pMatrixUniform, false, pMatrix);
		gl.uniformMatrix4fv(program.mvMatrixUniform, false, mvMatrix);
	}

	function frame() {
		gl.viewport(0, 0, viewportWidth, viewportHeight);
		gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

		//mat4.perspective(45, viewportWidth/viewportHeight, 0.1, 100.0, projectionMatrix);
		mat4.ortho(-1.0, 1.0, -1.0, 1.0, 0.1, 100.0, projectionMatrix);
		mat4.identity(modelViewMatrix);
		mat4.translate(modelViewMatrix, [0.0, 0.0, -2.0]);

		updateMatrices(program, modelViewMatrix, projectionMatrix);
	
		// plug buffers to the corresponding vertex attributes
		gl.bindBuffer(gl.ARRAY_BUFFER, vertexPositionsBuffer);
		gl.vertexAttribPointer(program.vertexPositionAttribute, vertexPositionsBuffer.itemSize, gl.FLOAT, false, 0, 0);
		gl.bindBuffer(gl.ARRAY_BUFFER, textureCoordinatesBuffer);
		gl.vertexAttribPointer(program.textureCoordinatesAttribute, textureCoordinatesBuffer.itemSize, gl.FLOAT, false, 0, 0);
		gl.drawArrays(gl.TRIANGLE_STRIP, 0, vertexPositionsBuffer.numItems);
	}
</script>
</body>
</html>