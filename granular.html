<script src="./pico.dev.js"></script>
<script src="./seedrandom.js"></script>
<script>
	function grain(mu, sigma, f, t) {
		return Math.sin(t*Math.PI*2*f)*Math.exp(-Math.pow(mu-t,2)/(sigma*sigma));
	}
    function synth() {
		var freq = 220,
			cell_frames = 32,
			impulses = 16,
			pulse = 1,
			spread = .5,
			tones = 7;
		var norm = 1/(1.5+3*Math.log(impulses));
		var offset = 0xbeefbeef;
		var t = 0,
			sample = 0,
			frame = 0,
			step = 1.0/pico.samplerate;
        return {
			process: function(L, R) {
				var cell_seconds = cell_frames*L.length/pico.samplerate;
				var cell = Math.floor(frame/cell_frames);
				for(var c= -1; c<=1; c++){
					var cc = cell+c;
					Math.seedrandom(cc^offset);
					var rf = [], mu = [], pan = [];
					for (var i = 0; i < impulses; i++) {
						rf[i] = freq*(1+Math.floor(Math.random()*tones)*(7)/(tones-1));
						mu[i] = (cc+pulse*Math.random())*cell_seconds;
						pan[i] = .5+.5*spread*(Math.random()-.5);
					}
					var local_t = t;
//						local_sample = sample;
					for (var i = 0; i < L.length; i++) {
						var ls =0, rs=0;;
						for (var j = 0; j < impulses; j++) {
							var s= norm*grain(mu[j], cell_seconds/3, rf[j], local_t);
							ls += s*pan[j];
							rs += s*(1-pan[j]);
						}
						if(c==-1) { L[i]=R[i]=0; }
						L[i] += ls; R[i]+=rs;
						local_t+=step;
	//					local_sample++;
					}
				}
				frame++;
				t = local_t;
		//		sample = local_sample;
            }
        };
    }
	pico.play(synth());
</script>